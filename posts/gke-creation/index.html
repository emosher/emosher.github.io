<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Hugo 0.110.0"><meta name=description content="Background Google Kubernetes Engine (GKE) has become one of my favorite ways to easily spin up a Kubernetes cluster. I find Google Cloud overall to be very easy to use and get started with, and so I’ve taken to using GKE often. I use other providers too, but GKE is pretty my go to. Most often, I’m using a cluster to deploy Tanzu Application Platform on top of it.
Problem I believe that clusters can and should be disposable."><link rel=stylesheet href=https://emosher.dev/css/normalize.css><link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel=stylesheet type=text/css><link rel=stylesheet href=https://emosher.dev/css/cayman.a134bfd387c4421893b8b84f607a0e7f301904bffa11e51ed538af8a40d4c4f3.css><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><title>GKE Cluster Creation | emosher.dev</title></head><body><section class=page-header><h1 class=project-name>Eric&rsquo;s Blog</h1><h2 class=project-tagline>A technologist just trying to navigate through life</h2><nav><a href=/ class=btn>Blog</a>
<a href=/tags/ class=btn>Tags</a>
<a href=/about/ class=btn>About</a>
<a href=/index.xml class=btn>RSS</a></nav></section><section class=main-content><h1>GKE Cluster Creation</h1><h3 id=background>Background</h3><p>Google Kubernetes Engine (GKE) has become one of my favorite ways to easily spin up a Kubernetes cluster. I find Google Cloud overall to be very easy to use and get started with, and so I&rsquo;ve taken to using GKE often. I use other providers too, but GKE is pretty my go to. Most often, I&rsquo;m using a cluster to deploy <a href=https://tanzu.vmware.com/application-platform>Tanzu Application Platform</a> on top of it.</p><h3 id=problem>Problem</h3><p>I believe that clusters can and should be disposable. Thus, I find myself recreating clusters often. While the web UI is a great option, I&rsquo;ve also find the need to tweak certain knobs from time to time. Since I use my clusters with Tanzu Application Platform, I also need certain features for that to work. I needed to find a way to more repeatably create clusters while getting the right flags enabled.</p><h3 id=solution>Solution</h3><p>This solution assumes you have installed and <a href=https://cloud.google.com/sdk/docs/initializing>set up</a> the <code>gcloud</code> CLI, or are running this in the Google Cloud Shell.</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#19177c>CLUSTER</span><span style=color:#666>=</span>tap-demo
</span></span><span style=display:flex><span><span style=color:#19177c>GKE_VERSION</span><span style=color:#666>=</span>1.24.5-gke.600
</span></span><span style=display:flex><span><span style=color:#19177c>NODE_TYPE</span><span style=color:#666>=</span>e2-standard-2
</span></span><span style=display:flex><span><span style=color:#19177c>NUM_NODES</span><span style=color:#666>=</span><span style=color:#666>4</span>
</span></span><span style=display:flex><span><span style=color:#19177c>PROJ</span><span style=color:#666>=</span>my-project
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gcloud beta container --project <span style=color:#19177c>$PROJ</span> clusters create <span style=color:#19177c>$CLUSTER</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span> --region <span style=color:#ba2121>&#34;us-east4&#34;</span> --no-enable-basic-auth <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span> --cluster-version <span style=color:#19177c>$GKE_VERSION</span> --release-channel <span style=color:#ba2121>&#34;regular&#34;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span> --machine-type <span style=color:#19177c>$NODE_TYPE</span> --image-type <span style=color:#ba2121>&#34;COS_CONTAINERD&#34;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span> --disk-type <span style=color:#ba2121>&#34;pd-balanced&#34;</span> --disk-size <span style=color:#ba2121>&#34;100&#34;</span> --metadata disable-legacy-endpoints<span style=color:#666>=</span><span style=color:green>true</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span> --scopes <span style=color:#ba2121>&#34;https://www.googleapis.com/auth/devstorage.read_only&#34;</span>,<span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span><span style=color:#ba2121>&#34;https://www.googleapis.com/auth/logging.write&#34;</span>,<span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span><span style=color:#ba2121>&#34;https://www.googleapis.com/auth/monitoring&#34;</span>,<span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span><span style=color:#ba2121>&#34;https://www.googleapis.com/auth/servicecontrol&#34;</span>,<span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span><span style=color:#ba2121>&#34;https://www.googleapis.com/auth/service.management.readonly&#34;</span>,<span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span><span style=color:#ba2121>&#34;https://www.googleapis.com/auth/trace.append&#34;</span>,<span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span><span style=color:#ba2121>&#34;https://www.googleapis.com/auth/ndev.clouddns.readwrite&#34;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span> --max-pods-per-node <span style=color:#ba2121>&#34;110&#34;</span> --num-nodes <span style=color:#19177c>$NUM_NODES</span> --logging<span style=color:#666>=</span>SYSTEM,WORKLOAD <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span> --monitoring<span style=color:#666>=</span>SYSTEM --enable-ip-alias <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span> --network <span style=color:#ba2121>&#34;projects/mosher-workspace/global/networks/default&#34;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span> --subnetwork <span style=color:#ba2121>&#34;projects/mosher-workspace/regions/us-east4/subnetworks/default&#34;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span> --no-enable-intra-node-visibility --default-max-pods-per-node <span style=color:#ba2121>&#34;110&#34;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span> --no-enable-master-authorized-networks <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span> --addons HorizontalPodAutoscaling,HttpLoadBalancing,GcePersistentDiskCsiDriver --enable-autoupgrade <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span> --enable-autorepair --max-surge-upgrade <span style=color:#666>1</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span> --max-unavailable-upgrade <span style=color:#666>0</span> --enable-shielded-nodes <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span> --node-locations <span style=color:#ba2121>&#34;us-east4-a&#34;</span>
</span></span></code></pre></div><h3 id=further-details>Further Details</h3><p>First, of note for me is that I need <code>"https://www.googleapis.com/auth/ndev.clouddns.readwrite"</code> in order for <a href=https://github.com/kubernetes-sigs/external-dns/blob/master/docs/tutorials/gke.md>External DNS</a> to work. I moved the common things I need to change to variables, but you could certainly move other things there if needed. For example, you may want a different region but I almost always use <code>us-east4</code>.</p><p>Second, since this is a regional cluster, we need to specify <code>--node-locations "us-east4-a"</code> or else it would use all 3 zones. This would be great for production workloads, but isn&rsquo;t necessary for me. If you omitted this option, it would create a 12 node cluster in this example (4 nodes X 3 zones).</p><p>Last, I think it&rsquo;s important to point out how I got here - go to the GKE cluster creation screen in the Web UI, and you can select options in the GUI and then select the equivalent &ldquo;command line&rdquo; link at the bottom of the page. From there, you can customize the command to your liking or add it to your own scripting.</p><p><img src=/gke-gui-cli.png alt="Command Line" title="GKE GUI CLI Link"></p><footer class=site-footer><span class=site-footer-credits>Made with <a href=https://gohugo.io/>Hugo</a>. Themed by <a href=https://github.com/zwbetz-gh/cayman-hugo-theme>Cayman</a>. Deployed to <a href=https://pages.github.com/>GitHub Pages</a>.</span></footer></section></body></html>